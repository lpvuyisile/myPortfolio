<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-50 min-h-screen p-4 md:p-10 font-sans">

    <div class="max-w-5xl mx-auto">
        <!-- Auth Header -->
        <div class="bg-black text-white rounded-2xl p-8 mb-10 shadow-xl">
            <h1 class="text-2xl font-bold mb-6">Portfolio Manager</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-zinc-400 mb-2">GitHub Personal Token</label>
                    <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx" class="w-full bg-zinc-900 border border-zinc-700 p-3 rounded-lg text-white">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest text-zinc-400 mb-2">Repository (User/Repo)</label>
                    <input type="text" id="gh-repo" placeholder="username/my-portfolio" class="w-full bg-zinc-900 border border-zinc-700 p-3 rounded-lg text-white">
                </div>
            </div>
            <div class="mt-6 flex items-center gap-4">
                <button onclick="saveSettings()" class="bg-white text-black px-8 py-3 rounded-full font-bold hover:bg-zinc-200 transition">Connect to GitHub</button>
                <p id="status-msg" class="text-sm font-medium"></p>
            </div>
        </div>

        <div id="admin-content" class="hidden space-y-10">
            <!-- PDF Upload & Select -->
            <div class="bg-white rounded-2xl shadow-sm border border-zinc-200 p-8">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="bg-zinc-100 p-2 rounded-lg">üìÑ</span> 1. Featured Publication
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div>
                        <label class="block text-sm font-semibold mb-3">Upload New PDF</label>
                        <div class="flex gap-2">
                            <input type="file" id="pdf-file" accept=".pdf" class="block w-full text-sm text-zinc-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-zinc-100 file:text-zinc-700 hover:file:bg-zinc-200">
                            <button onclick="handleUpload('pdf')" class="bg-zinc-800 text-white px-4 py-2 rounded-lg text-sm">Upload</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-3">Select Active Flipbook</label>
                        <select id="active-pdf" class="w-full border border-zinc-200 p-3 rounded-xl bg-zinc-50 text-sm focus:ring-2 focus:ring-black outline-none"></select>
                    </div>
                </div>
            </div>

            <!-- Image Slots -->
            <div class="bg-white rounded-2xl shadow-sm border border-zinc-200 p-8">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="bg-zinc-100 p-2 rounded-lg">üñºÔ∏è</span> 2. Gallery Slots (6 Total)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="slots-container">
                    <!-- Slots generated by JS -->
                </div>
            </div>

            <!-- Global Publish -->
            <div class="sticky bottom-10">
                <button onclick="publishChanges()" id="publish-btn" class="w-full bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-2xl hover:bg-blue-700 transform active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                    <span id="btn-text">PUBLISH ALL CHANGES TO LIVE SITE</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let config = { selectedPdf: "", slots: Array(6).fill({image:"", name:"", desc:""}) };
        let repoFiles = [];

        // UI Generation
        const container = document.getElementById('slots-container');
        for(let i=0; i<6; i++) {
            container.innerHTML += `
                <div class="border border-zinc-200 p-5 rounded-2xl bg-zinc-50/50 hover:bg-white transition-colors">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-zinc-400 text-xs uppercase tracking-widest">Slot ${i+1}</h3>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-[10px] uppercase font-bold text-zinc-400 mb-1">New Upload</label>
                        <div class="flex gap-1">
                            <input type="file" id="slot-file-${i}" class="text-[10px] w-full" accept="image/*">
                            <button onclick="handleUpload('image', ${i})" class="bg-zinc-200 text-zinc-700 px-2 py-1 rounded text-[10px] font-bold">Upload</button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <select id="slot-select-${i}" class="w-full border border-zinc-200 p-2 rounded-lg text-sm bg-white"></select>
                        <input type="text" id="slot-name-${i}" placeholder="Project Name" class="w-full border border-zinc-200 p-2 rounded-lg text-sm">
                        <textarea id="slot-desc-${i}" placeholder="Short description..." class="w-full border border-zinc-200 p-2 rounded-lg text-sm h-16"></textarea>
                    </div>
                </div>
            `;
        }

        function saveSettings() {
            localStorage.setItem('gh_token', document.getElementById('gh-token').value);
            localStorage.setItem('gh_repo', document.getElementById('gh-repo').value);
            initAdmin();
        }

        async function initAdmin() {
            const token = localStorage.getItem('gh_token');
            const repo = localStorage.getItem('gh_repo');
            if(!token || !repo) return;

            document.getElementById('gh-token').value = token;
            document.getElementById('gh-repo').value = repo;
            const status = document.getElementById('status-msg');

            try {
                status.innerText = "‚è≥ Connecting...";
                
                // 1. Get current config
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/config.json`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if(!res.ok) throw new Error("Could not find config.json");
                const data = await res.json();
                config = JSON.parse(decodeURIComponent(escape(atob(data.content))));

                // 2. Get asset list
                const assetsRes = await fetch(`https://api.github.com/repos/${repo}/contents/assets`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                repoFiles = await assetsRes.json();

                populateUI();
                document.getElementById('admin-content').classList.remove('hidden');
                status.innerText = "‚úÖ Synchronized with GitHub";
                status.className = "text-sm font-medium text-green-500";
            } catch (e) {
                status.innerText = "‚ùå Connection Error: Check token/repo or if config.json exists.";
                status.className = "text-sm font-medium text-red-500";
            }
        }

        function populateUI() {
            const pdfSelect = document.getElementById('active-pdf');
            pdfSelect.innerHTML = '<option value="">(None Selected)</option>';
            
            // Setup dropdowns
            repoFiles.forEach(file => {
                if(file.name.endsWith('.pdf')) {
                    pdfSelect.innerHTML += `<option value="${file.name}" ${config.selectedPdf === file.name ? 'selected' : ''}>${file.name}</option>`;
                }
                for(let i=0; i<6; i++) {
                    const sel = document.getElementById(`slot-select-${i}`);
                    if(sel.options.length === 0) sel.innerHTML = '<option value="">(None)</option>';
                    if(file.name.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                        sel.innerHTML += `<option value="${file.name}" ${config.slots[i].image === file.name ? 'selected' : ''}>${file.name}</option>`;
                    }
                }
            });

            // Set text fields
            config.slots.forEach((slot, i) => {
                document.getElementById(`slot-name-${i}`).value = slot.name || '';
                document.getElementById(`slot-desc-${i}`).value = slot.desc || '';
            });
        }

        async function handleUpload(type, index = null) {
            const input = type === 'pdf' ? document.getElementById('pdf-file') : document.getElementById(`slot-file-${index}`);
            if(!input.files[0]) return alert("Please select a file first.");
            
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                const token = localStorage.getItem('gh_token');
                const repo = localStorage.getItem('gh_repo');
                const path = `assets/${file.name}`;

                // Check for existing file SHA (to update/overwrite)
                let sha = null;
                const check = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if(check.ok) {
                    const existing = await check.json();
                    sha = existing.sha;
                }

                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Upload ${file.name} via Admin`,
                        content: base64,
                        sha: sha || undefined
                    })
                });

                if(res.ok) {
                    alert("Upload successful! Refreshing list...");
                    initAdmin();
                } else {
                    alert("Upload failed. Check permissions.");
                }
            };
            reader.readAsDataURL(file);
        }

        async function publishChanges() {
            const btn = document.getElementById('publish-btn');
            const token = localStorage.getItem('gh_token');
            const repo = localStorage.getItem('gh_repo');

            btn.disabled = true;
            document.getElementById('btn-text').innerText = "PUBLISHING...";

            // Update local config object from UI
            config.selectedPdf = document.getElementById('active-pdf').value;
            for(let i=0; i<6; i++) {
                config.slots[i] = {
                    image: document.getElementById(`slot-select-${i}`).value,
                    name: document.getElementById(`slot-name-${i}`).value,
                    desc: document.getElementById(`slot-desc-${i}`).value
                };
            }

            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/config.json`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const existing = await res.json();

                const update = await fetch(`https://api.github.com/repos/${repo}/contents/config.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Update portfolio configuration",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(config, null, 2)))),
                        sha: existing.sha
                    })
                });

                if(update.ok) {
                    alert("SUCCESS! The live site will reflect changes in ~60 seconds.");
                } else {
                    throw new Error();
                }
            } catch (e) {
                alert("Failed to publish. Check your connection.");
            } finally {
                btn.disabled = false;
                document.getElementById('btn-text').innerText = "PUBLISH ALL CHANGES TO LIVE SITE";
            }
        }

        window.onload = initAdmin;
    </script>
</body>
</html>
